<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt-dlp web</title>
    <meta name="description" content="Self-hosted yt-dlp web interface with full parameter support">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet"
        integrity="sha256-CLgMENMGOk+RMGnOCbiHoMYsYtFGJQlQLkn5d3GyTag=" crossorigin="anonymous">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.14.3/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', system-ui, sans-serif;
        }

        [data-theme="ytdlp-light"] {
            --p: 162 68% 44%;
            --pf: 162 68% 37%;
            --s: 199 89% 48%;
            --sf: 199 89% 40%;
            --a: 270 60% 62%;
            --af: 270 60% 52%;
            --b1: 180 10% 98%;
            --b2: 180 8% 95%;
            --b3: 180 6% 91%;
            --bc: 220 15% 18%;
            --n: 220 15% 25%;
            --nf: 220 15% 18%;
            --nc: 0 0% 100%;
            --in: 199 89% 48%;
            --su: 162 68% 44%;
            --wa: 41 88% 58%;
            --er: 0 70% 55%;
            --rounded-box: 1rem;
            --rounded-btn: .5rem;
        }

        [data-theme="ytdlp-dark"] {
            --p: 162 65% 50%;
            --pf: 162 65% 40%;
            --s: 199 80% 55%;
            --sf: 199 80% 45%;
            --a: 270 55% 70%;
            --af: 270 55% 58%;
            --b1: 222 20% 10%;
            --b2: 222 18% 13%;
            --b3: 222 16% 17%;
            --bc: 210 20% 88%;
            --n: 210 15% 82%;
            --nf: 210 15% 92%;
            --nc: 222 20% 10%;
            --in: 199 80% 55%;
            --su: 162 65% 50%;
            --wa: 41 88% 58%;
            --er: 0 70% 55%;
            --rounded-box: 1rem;
            --rounded-btn: .5rem;
        }

        .glass-card {
            background: oklch(from oklch(var(--b1) / 1) l c h / 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid oklch(from oklch(var(--bc) / 1) l c h / 0.08);
        }

        @supports not (color: oklch(0 0 0)) {
            .glass-card {
                background: var(--fallback-b1, hsl(var(--b1)));
            }
        }

        .log-box::-webkit-scrollbar {
            width: 6px;
        }

        .log-box::-webkit-scrollbar-thumb {
            background: hsl(var(--p));
            border-radius: 3px;
        }

        .log-box {
            scrollbar-width: thin;
            scrollbar-color: hsl(var(--p)) transparent;
        }

        .fade-in {
            animation: fadeIn .3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }
    </style>
</head>

<body class="min-h-screen bg-base-200 text-base-content" x-data="app()">

    <!-- Navbar -->
    <nav class="navbar bg-base-100/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm px-4">
        <div class="flex-1 gap-2">
            <span
                class="text-xl font-bold bg-gradient-to-r from-emerald-400 to-sky-400 bg-clip-text text-transparent">yt-dlp
                web</span>
        </div>
        <div class="flex-none gap-2 flex items-center">
            <!-- Language toggle -->
            <button class="btn btn-ghost btn-sm btn-circle" @click="toggleLang"
                :title="lang==='en'?'ÂàáÊç¢‰∏≠Êñá':'Switch English'"
                :aria-label="lang==='en'?'ÂàáÊç¢‰∏≠Êñá':'Switch English'">
                <span class="text-sm font-bold" x-text="lang==='en'?'‰∏≠':'EN'"></span>
            </button>
            <!-- Theme toggle -->
            <button class="btn btn-ghost btn-sm btn-circle" @click="toggleTheme"
                :title="dark ? t('lightMode') : t('darkMode')"
                :aria-label="dark ? t('lightMode') : t('darkMode')">
                <svg x-show="dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" aria-hidden="true">
                    <circle cx="12" cy="12" r="5" />
                    <path
                        d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                </svg>
                <svg x-show="!dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z" />
                </svg>
            </button>
            <div class="badge badge-sm badge-outline" role="status" aria-live="polite" x-text="wsStatus"></div>
        </div>
    </nav>

    <main class="container mx-auto max-w-4xl px-4 py-6 space-y-6">

        <!-- URL Input Card -->
        <div class="card bg-base-100 shadow-lg glass-card fade-in">
            <div class="card-body p-5">
                <form @submit.prevent="submit">
                    <div class="join w-full">
                        <input type="text" x-model="form.url"
                            :placeholder="form.is_raw ? t('rawPlaceholder') : t('urlPlaceholder')"
                            class="input input-bordered join-item flex-1 font-mono text-sm"
                            :class="form.is_raw && 'input-accent'" required>
                        <button type="submit" class="btn btn-primary join-item gap-1" :disabled="loading">
                            <span x-show="!loading" x-text="'‚¨á '+t('download')"></span>
                            <span x-show="loading" class="loading loading-spinner loading-xs"></span>
                        </button>
                    </div>

                    <div class="flex flex-wrap items-center gap-3 mt-3">
                        <label class="label cursor-pointer gap-1 p-0">
                            <input type="checkbox" x-model="form.is_raw" class="toggle toggle-xs toggle-accent">
                            <span class="label-text text-xs" x-text="t('rawCommand')"></span>
                        </label>
                        <button type="button" class="btn btn-ghost btn-xs" @click="showFormats"
                            x-text="'üìã '+t('listFormats')"></button>
                        <button type="button" class="btn btn-ghost btn-xs" @click="showAdvanced=!showAdvanced"
                            x-text="showAdvanced ? '‚ñ≤ '+t('hideOptions') : '‚ñº '+t('moreOptions')"></button>
                    </div>
                </form>

                <!-- Quick Options -->
                <div x-show="!form.is_raw" class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-base-300">
                    <select x-model="form.format" class="select select-bordered select-xs">
                        <option value="" x-text="t('bestDefault')"></option>
                        <option value="bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]" x-text="t('bestMp4')">
                        </option>
                        <option value="bestvideo[height<=1080]+bestaudio/best" x-text="t('max1080')"></option>
                        <option value="bestvideo[height<=720]+bestaudio/best" x-text="t('max720')"></option>
                        <option value="bestvideo[height<=480]+bestaudio/best" x-text="t('max480')"></option>
                        <option value="bestaudio/best" x-text="t('audioOnly')"></option>
                    </select>
                    <label class="label cursor-pointer gap-1"><input type="checkbox" x-model="form.audio_only"
                            class="checkbox checkbox-xs checkbox-primary"><span class="text-xs"
                            x-text="t('extractAudio')"></span></label>
                    <label class="label cursor-pointer gap-1"><input type="checkbox" x-model="form.embed_subs"
                            class="checkbox checkbox-xs checkbox-primary"><span class="text-xs"
                            x-text="t('embedSubs')"></span></label>
                    <label class="label cursor-pointer gap-1"><input type="checkbox" x-model="form.embed_thumb"
                            class="checkbox checkbox-xs checkbox-primary"><span class="text-xs"
                            x-text="t('embedThumb')"></span></label>
                    <label class="label cursor-pointer gap-1"><input type="checkbox" x-model="form.embed_meta"
                            class="checkbox checkbox-xs checkbox-primary"><span class="text-xs"
                            x-text="t('embedMeta')"></span></label>
                    <label class="label cursor-pointer gap-1"><input type="checkbox" x-model="form.no_playlist"
                            class="checkbox checkbox-xs checkbox-primary"><span class="text-xs"
                            x-text="t('noPlaylist')"></span></label>
                </div>

                <!-- Advanced Options Panel -->
                <div x-show="showAdvanced && !form.is_raw" x-collapse
                    class="mt-4 space-y-4 border-t border-base-300 pt-4">

                    <!-- Authentication -->
                    <details class="collapse collapse-arrow bg-base-200 rounded-lg">
                        <summary class="collapse-title text-sm font-medium min-h-0 py-2" x-text="'üîê '+t('authTitle')">
                        </summary>
                        <div class="collapse-content grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('usernameHelp')"></span></label><input x-model="form.username"
                                    class="input input-bordered input-xs w-full" placeholder="oauth2"></div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('passwordHelp')"></span></label><input x-model="form.password"
                                    class="input input-bordered input-xs w-full" type="password"></div>
                            <div class="sm:col-span-2"><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('cookiesHelp')"></span></label><input x-model="form.cookies_from"
                                    class="input input-bordered input-xs w-full" placeholder="chrome"></div>
                        </div>
                    </details>

                    <!-- Subtitles -->
                    <details class="collapse collapse-arrow bg-base-200 rounded-lg">
                        <summary class="collapse-title text-sm font-medium min-h-0 py-2" x-text="'üí¨ '+t('subsTitle')">
                        </summary>
                        <div class="collapse-content grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                            <label class="label cursor-pointer gap-1"><input type="checkbox" x-model="form.write_subs"
                                    class="checkbox checkbox-xs"><span class="text-xs"
                                    x-text="t('writeSubs')"></span></label>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('subLangsHelp')"></span></label><input x-model="form.sub_langs"
                                    class="input input-bordered input-xs w-full" placeholder="en,zh-Hans,ja"></div>
                        </div>
                    </details>

                    <!-- Post-processing -->
                    <details class="collapse collapse-arrow bg-base-200 rounded-lg">
                        <summary class="collapse-title text-sm font-medium min-h-0 py-2" x-text="'üîß '+t('ppTitle')">
                        </summary>
                        <div class="collapse-content grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('audioFormatHelp')"></span></label><input x-model="form.audio_format"
                                    class="input input-bordered input-xs w-full" placeholder="mp3"></div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('mergeFormatHelp')"></span></label>
                                <select x-model="form.merge_format" class="select select-bordered select-xs w-full">
                                    <option value="" x-text="t('auto')"></option>
                                    <option>mp4</option>
                                    <option>mkv</option>
                                    <option>webm</option>
                                </select>
                            </div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('remuxHelp')"></span></label><input x-model="form.remux_video"
                                    class="input input-bordered input-xs w-full" placeholder="mp4"></div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('recodeHelp')"></span></label><input x-model="form.recode_video"
                                    class="input input-bordered input-xs w-full" placeholder=""></div>
                            <label class="label cursor-pointer gap-1"><input type="checkbox"
                                    x-model="form.embed_chapter" class="checkbox checkbox-xs"><span class="text-xs"
                                    x-text="t('embedChapters')"></span></label>
                            <label class="label cursor-pointer gap-1"><input type="checkbox" x-model="form.write_thumb"
                                    class="checkbox checkbox-xs"><span class="text-xs"
                                    x-text="t('writeThumb')"></span></label>
                            <label class="label cursor-pointer gap-1"><input type="checkbox" x-model="form.write_desc"
                                    class="checkbox checkbox-xs"><span class="text-xs"
                                    x-text="t('writeDesc')"></span></label>
                            <label class="label cursor-pointer gap-1"><input type="checkbox"
                                    x-model="form.write_info_json" class="checkbox checkbox-xs"><span class="text-xs"
                                    x-text="t('writeInfoJson')"></span></label>
                            <div><label class="label py-0"><span class="label-text text-xs">SponsorBlock</span></label>
                                <select x-model="form.sponsorblock" class="select select-bordered select-xs w-full">
                                    <option value="" x-text="t('off')"></option>
                                    <option value="mark" x-text="t('sbMark')"></option>
                                    <option value="remove" x-text="t('sbRemove')"></option>
                                </select>
                            </div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('ppArgsHelp')"></span></label><input x-model="form.pp_args"
                                    class="input input-bordered input-xs w-full font-mono"
                                    placeholder='ffmpeg:-c:a aac'></div>
                        </div>
                    </details>

                    <!-- Network & Download -->
                    <details class="collapse collapse-arrow bg-base-200 rounded-lg">
                        <summary class="collapse-title text-sm font-medium min-h-0 py-2"
                            x-text="'üåê '+t('networkTitle')"></summary>
                        <div class="collapse-content grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('proxy')"></span></label><input x-model="form.proxy"
                                    class="input input-bordered input-xs w-full" placeholder="socks5://127.0.0.1:1080">
                            </div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('rateLimit')"></span></label><input x-model="form.rate_limit"
                                    class="input input-bordered input-xs w-full" placeholder="4.2M"></div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('concFrags')"></span></label><input x-model="form.conc_frags"
                                    class="input input-bordered input-xs w-full" placeholder="1"></div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('extractorArgs')"></span></label><input x-model="form.extractor_args"
                                    class="input input-bordered input-xs w-full font-mono"
                                    placeholder='youtube:player_client=android,web'></div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('sleepInterval')"></span></label><input x-model="form.sleep_interval"
                                    class="input input-bordered input-xs w-full" placeholder="2"></div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('maxSleep')"></span></label><input x-model="form.max_sleep"
                                    class="input input-bordered input-xs w-full" placeholder="6"></div>
                        </div>
                    </details>

                    <!-- Playlist & Output -->
                    <details class="collapse collapse-arrow bg-base-200 rounded-lg">
                        <summary class="collapse-title text-sm font-medium min-h-0 py-2"
                            x-text="'üìÅ '+t('playlistTitle')"></summary>
                        <div class="collapse-content grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('playlistItemsHelp')"></span></label><input
                                    x-model="form.playlist_items" class="input input-bordered input-xs w-full"
                                    placeholder=""></div>
                            <div><label class="label py-0"><span class="label-text text-xs"
                                        x-text="t('outputTmplHelp')"></span></label><input x-model="form.output_tmpl"
                                    class="input input-bordered input-xs w-full font-mono"
                                    placeholder="%(title)s.%(ext)s"></div>
                        </div>
                    </details>

                    <!-- Extra args -->
                    <div>
                        <label class="label py-0"><span class="label-text text-xs"
                                x-text="t('extraArgsHelp')"></span></label>
                        <input x-model="form.args" class="input input-bordered input-xs w-full font-mono"
                            placeholder="--verbose --write-comments">
                    </div>
                </div>
            </div>
        </div>

        <!-- Format listing modal -->
        <dialog x-ref="fmtDialog" @close="formatModal=false" x-effect="formatModal ? $refs.fmtDialog.showModal() : ($refs.fmtDialog.open && $refs.fmtDialog.close())" class="modal modal-bottom sm:modal-middle">
            <div class="modal-box max-w-3xl">
                <h3 class="font-bold text-lg mb-2" x-text="t('availableFormats')"></h3>
                <pre class="bg-neutral text-neutral-content p-3 rounded-lg text-xs overflow-auto max-h-96 whitespace-pre-wrap"
                    x-text="formatOutput || t('loading')"></pre>
                <div class="modal-action"><button class="btn btn-sm" @click="formatModal=false"
                        x-text="t('close')"></button></div>
            </div>
            <form method="dialog" class="modal-backdrop"><button @click="formatModal=false">close</button></form>
        </dialog>

        <!-- Download Queue -->
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <span x-text="t('downloads')"></span>
                    <span class="badge badge-sm badge-primary" x-text="tasks.length" x-show="tasks.length > 0"></span>
                </h2>
                <button x-show="tasks.some(t=>['completed','failed','cancelled'].includes(t.status))"
                    @click="clearDone()" class="btn btn-ghost btn-xs" x-text="t('clearDone')"></button>
            </div>

            <div x-show="tasks.length===0" class="text-center py-12 text-base-content/40">
                <div class="text-4xl mb-2">üì≠</div>
                <p x-text="t('emptyQueue')"></p>
            </div>

            <template x-for="task in tasks" :key="task.id">
                <div class="card bg-base-100 shadow-sm border border-base-300/50 fade-in">
                    <div class="card-body p-4 gap-2">
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-sm truncate" x-text="task.title" :title="task.url"></h3>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="badge badge-xs" :class="statusBadge(task.status)"
                                        x-text="t('status_'+task.status)"></span>
                                    <span x-show="task.status==='running'"
                                        class="text-xs text-base-content/60 font-mono"
                                        x-text="[task.speed, task.size, task.eta?('ETA '+task.eta):''].filter(Boolean).join(' ¬∑ ')"></span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <button x-show="task.status==='running'" @click="pause(task.id)"
                                    class="btn btn-ghost btn-xs" :title="t('pause')" :aria-label="t('pause')">‚è∏</button>
                                <button x-show="task.status==='paused'" @click="resume(task.id)"
                                    class="btn btn-ghost btn-xs" :title="t('resume')" :aria-label="t('resume')">‚ñ∂</button>
                                <button x-show="task.status==='running'||task.status==='queued'"
                                    @click="cancel(task.id)" class="btn btn-ghost btn-xs text-error"
                                    :title="t('cancelBtn')" :aria-label="t('cancelBtn')">‚úï</button>
                                <button
                                    x-show="task.status==='failed'||task.status==='completed'||task.status==='cancelled'"
                                    @click="retry(task.id)" class="btn btn-ghost btn-xs" :title="t('retry')" :aria-label="t('retry')">üîÑ</button>
                                <button x-show="task.status!=='running'" @click="del(task.id)"
                                    class="btn btn-ghost btn-xs text-error/60" :title="t('deleteBtn')" :aria-label="t('deleteBtn')">üóë</button>
                                <button @click="task._showLog=!task._showLog" class="btn btn-ghost btn-xs"
                                    :title="t('logs')" x-text="task._showLog ? '‚ñ≤' : '‚ñº'"></button>
                            </div>
                        </div>

                        <!-- Progress bar -->
                        <div x-show="task.percent > 0 || task.status==='running'" class="w-full mt-2">
                            <progress class="progress progress-primary w-full h-1.5" :value="task.percent"
                                max="100"></progress>
                            <div class="text-right text-[11px] font-mono text-primary" x-text="task.progress"></div>
                        </div>

                        <!-- Error Banner for mobile visibility -->
                        <div x-show="task.error"
                            class="bg-error/10 text-error rounded p-2 mt-2 text-xs break-words border border-error/20 font-medium">
                            ‚ö† <span x-text="task.error"></span>
                        </div>

                        <!-- Logs -->
                        <div x-show="task._showLog" x-collapse>
                            <div class="bg-neutral text-neutral-content rounded-lg p-2 mt-1 max-h-48 overflow-y-auto text-[11px] font-mono log-box"
                                :id="'log-'+task.id">
                                <template x-for="(l,i) in task.logs" :key="i">
                                    <div class="whitespace-pre-wrap break-all leading-tight" x-text="l"></div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Toast Container -->
        <div class="toast toast-top toast-center z-50" role="alert" aria-live="polite">
            <template x-for="toast in toasts" :key="toast.id">
                <div class="alert fade-in shadow-xl"
                    :class="{'alert-error': toast.type==='error', 'alert-success': toast.type==='success', 'alert-info': toast.type==='info'}">
                    <span x-text="toast.msg"></span>
                </div>
            </template>
        </div>
    </main>

    <footer class="text-center py-6 text-xs text-base-content/30">yt-dlp web ‚Äî self-hosted</footer>

    <script>
        // =================== i18n strings ===================
        const I18N = {
            en: {
                lightMode: 'Light mode', darkMode: 'Dark mode',
                urlPlaceholder: 'Paste video/playlist URL...',
                rawPlaceholder: 'yt-dlp --format best URL',
                download: 'Download', rawCommand: 'Raw Command',
                listFormats: 'List Formats', hideOptions: 'Hide Options', moreOptions: 'More Options',
                bestDefault: 'Best (default)', bestMp4: 'Best MP4', max1080: 'Max 1080p', max720: 'Max 720p', max480: 'Max 480p', audioOnly: 'Audio Only',
                extractAudio: 'Extract Audio', embedSubs: 'Embed Subs', embedThumb: 'Embed Thumb', embedMeta: 'Embed Metadata', noPlaylist: 'No Playlist',
                authTitle: 'Authentication & Cookies',
                usernameHelp: 'Username (use "oauth2" for YouTube OAuth)',
                passwordHelp: 'Password (leave empty for OAuth)',
                cookiesHelp: 'Cookies from browser (e.g. chrome, firefox)',
                subsTitle: 'Subtitles',
                writeSubs: 'Write subtitle files',
                subLangsHelp: 'Sub languages (comma-sep, regex ok)',
                ppTitle: 'Post-Processing',
                audioFormatHelp: 'Audio format (mp3/aac/opus/...)',
                mergeFormatHelp: 'Merge output format',
                auto: 'Auto', remuxHelp: 'Remux to', recodeHelp: 'Recode to',
                embedChapters: 'Embed chapters', writeThumb: 'Write thumbnail', writeDesc: 'Write description', writeInfoJson: 'Write info.json',
                off: 'Off', sbMark: 'Mark chapters', sbRemove: 'Remove segments',
                ppArgsHelp: 'PostProcessor args',
                networkTitle: 'Network & Download',
                proxy: 'Proxy', rateLimit: 'Rate limit', concFrags: 'Concurrent fragments',
                extractorArgs: 'Extractor args', sleepInterval: 'Sleep interval (s)', maxSleep: 'Max sleep interval (s)',
                playlistTitle: 'Playlist & Output',
                playlistItemsHelp: 'Playlist items (e.g. 1:5, 1,3,7)',
                outputTmplHelp: 'Output template',
                extraArgsHelp: 'Extra CLI args (appended to all UI options)',
                availableFormats: 'Available Formats', loading: 'Loading...', close: 'Close',
                downloads: 'Downloads', clearDone: 'Clear done', emptyQueue: 'No downloads yet. Paste a URL above to start.',
                status_queued: 'queued', status_running: 'running', status_completed: 'completed',
                status_failed: 'failed', status_cancelled: 'cancelled', status_paused: 'paused',
                pause: 'Pause', resume: 'Resume', cancelBtn: 'Cancel', retry: 'Retry', deleteBtn: 'Delete', logs: 'Logs',
                taskAdded: 'Task added to queue'
            },
            zh: {
                lightMode: 'ÊµÖËâ≤Ê®°Âºè', darkMode: 'Ê∑±Ëâ≤Ê®°Âºè',
                urlPlaceholder: 'Á≤òË¥¥ËßÜÈ¢ë/Êí≠ÊîæÂàóË°®ÈìæÊé•...',
                rawPlaceholder: 'yt-dlp --format best ÈìæÊé•',
                download: '‰∏ãËΩΩ', rawCommand: 'ÂéüÂßãÂëΩ‰ª§',
                listFormats: 'ÂàóÂá∫Ê†ºÂºè', hideOptions: 'Êî∂Ëµ∑ÈÄâÈ°π', moreOptions: 'Êõ¥Â§öÈÄâÈ°π',
                bestDefault: 'ÊúÄ‰Ω≥ÔºàÈªòËÆ§Ôºâ', bestMp4: 'ÊúÄ‰Ω≥ MP4', max1080: 'ÊúÄÈ´ò 1080p', max720: 'ÊúÄÈ´ò 720p', max480: 'ÊúÄÈ´ò 480p', audioOnly: '‰ªÖÈü≥È¢ë',
                extractAudio: 'ÊèêÂèñÈü≥È¢ë', embedSubs: 'ÂµåÂÖ•Â≠óÂπï', embedThumb: 'ÂµåÂÖ•Â∞ÅÈù¢', embedMeta: 'ÂµåÂÖ•ÂÖÉÊï∞ÊçÆ', noPlaylist: '‰∏ç‰∏ãËΩΩÊí≠ÊîæÂàóË°®',
                authTitle: 'ËÆ§ËØÅ & Cookies',
                usernameHelp: 'Áî®Êà∑ÂêçÔºàYouTube OAuthËØ∑Â°´"oauth2"Ôºâ',
                passwordHelp: 'ÂØÜÁ†ÅÔºàOAuthÁïôÁ©∫Âç≥ÂèØÔºâ',
                cookiesHelp: '‰ªéÊµèËßàÂô®ÂØºÂÖ• CookiesÔºàÂ¶Ç chrome„ÄÅfirefoxÔºâ',
                subsTitle: 'Â≠óÂπï',
                writeSubs: 'ÂÜôÂÖ•Â≠óÂπïÊñá‰ª∂',
                subLangsHelp: 'Â≠óÂπïËØ≠Ë®ÄÔºàÈÄóÂè∑ÂàÜÈöîÔºåÊîØÊåÅÊ≠£ÂàôÔºâ',
                ppTitle: 'ÂêéÂ§ÑÁêÜ',
                audioFormatHelp: 'Èü≥È¢ëÊ†ºÂºèÔºàmp3/aac/opus/...Ôºâ',
                mergeFormatHelp: 'ÂêàÂπ∂ËæìÂá∫Ê†ºÂºè',
                auto: 'Ëá™Âä®', remuxHelp: 'ËΩ¨Â∞ÅË£Ö‰∏∫', recodeHelp: 'ËΩ¨Á†Å‰∏∫',
                embedChapters: 'ÂµåÂÖ•Á´†ËäÇ', writeThumb: 'ÂÜôÂÖ•Áº©Áï•Âõæ', writeDesc: 'ÂÜôÂÖ•ÊèèËø∞', writeInfoJson: 'ÂÜôÂÖ• info.json',
                off: 'ÂÖ≥Èó≠', sbMark: 'Ê†áËÆ∞Á´†ËäÇ', sbRemove: 'ÁßªÈô§ÁâáÊÆµ',
                ppArgsHelp: 'ÂêéÂ§ÑÁêÜÂô®ÂèÇÊï∞',
                networkTitle: 'ÁΩëÁªú & ‰∏ãËΩΩ',
                proxy: '‰ª£ÁêÜ', rateLimit: 'ÈÄüÁéáÈôêÂà∂', concFrags: 'Âπ∂ÂèëÂàÜÊÆµÊï∞',
                extractorArgs: 'ÊèêÂèñÂô®ÂèÇÊï∞', sleepInterval: 'ËØ∑Ê±ÇÈó¥ÈöîÔºàÁßíÔºâ', maxSleep: 'ÊúÄÂ§ßÈó¥ÈöîÔºàÁßíÔºâ',
                playlistTitle: 'Êí≠ÊîæÂàóË°® & ËæìÂá∫',
                playlistItemsHelp: 'Êí≠ÊîæÂàóË°®È°πÔºàÂ¶Ç 1:5, 1,3,7Ôºâ',
                outputTmplHelp: 'ËæìÂá∫Ê®°Êùø',
                extraArgsHelp: 'È¢ùÂ§ñ CLI ÂèÇÊï∞ÔºàËøΩÂä†Âà∞ÊâÄÊúâ UI ÈÄâÈ°π‰πãÂêéÔºâ',
                availableFormats: 'ÂèØÁî®Ê†ºÂºè', loading: 'Âä†ËΩΩ‰∏≠...', close: 'ÂÖ≥Èó≠',
                downloads: '‰∏ãËΩΩÈòüÂàó', clearDone: 'Ê∏ÖÈô§Â∑≤ÂÆåÊàê', emptyQueue: 'ÊöÇÊó†‰∏ãËΩΩ‰ªªÂä°ÔºåËØ∑Âú®‰∏äÊñπÁ≤òË¥¥ÈìæÊé•ÂºÄÂßã‰∏ãËΩΩ„ÄÇ',
                status_queued: 'ÊéíÈòü‰∏≠', status_running: '‰∏ãËΩΩ‰∏≠', status_completed: 'Â∑≤ÂÆåÊàê',
                status_failed: 'Â§±Ë¥•', status_cancelled: 'Â∑≤ÂèñÊ∂à', status_paused: 'Â∑≤ÊöÇÂÅú',
                pause: 'ÊöÇÂÅú', resume: 'ÁªßÁª≠', cancelBtn: 'ÂèñÊ∂à', retry: 'ÈáçËØï', deleteBtn: 'Âà†Èô§', logs: 'Êó•Âøó',
                taskAdded: '‰ªªÂä°Â∑≤Ê∑ªÂä†Âà∞ÈòüÂàó'
            }
        };

        function app() {
            return {
                dark: true,
                lang: 'en',
                wsStatus: 'connecting',
                loading: false,
                showAdvanced: false,
                formatModal: false,
                formatOutput: '',
                tasks: [],
                ws: null,
                form: {
                    url: '', is_raw: false, args: '', format: '', audio_only: false, audio_format: '',
                    embed_subs: false, sub_langs: '', embed_thumb: false, embed_meta: false, embed_chapter: false,
                    sponsorblock: '', proxy: '', rate_limit: '', conc_frags: '', output_tmpl: '',
                    extractor_args: '', cookies_from: '', username: '', password: '',
                    no_playlist: false, playlist_items: '', write_subs: false, write_thumb: false,
                    write_desc: false, write_info_json: false, merge_format: '', remux_video: '',
                    recode_video: '', pp_args: '', sleep_interval: '', max_sleep: ''
                },

                t(key) { return (I18N[this.lang] && I18N[this.lang][key]) || (I18N.en[key]) || key; },

                init() {
                    const savedTheme = localStorage.getItem('theme');
                    this.dark = savedTheme ? savedTheme === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches;
                    this.lang = localStorage.getItem('lang') || (navigator.language.startsWith('zh') ? 'zh' : 'en');
                    this.applyTheme();
                    this.connectWS();
                },

                toggleTheme() { this.dark = !this.dark; localStorage.setItem('theme', this.dark ? 'dark' : 'light'); this.applyTheme(); },
                applyTheme() { document.documentElement.setAttribute('data-theme', this.dark ? 'ytdlp-dark' : 'ytdlp-light'); },
                toggleLang() { this.lang = this.lang === 'en' ? 'zh' : 'en'; localStorage.setItem('lang', this.lang); },

                _wsRetry: 1000,
                _wsTimer: null,
                connectWS() {
                    if (this._wsTimer) { clearTimeout(this._wsTimer); this._wsTimer = null; }
                    if (this.ws) { try { this.ws.close(); } catch {} }
                    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${proto}//${location.host}/ws`);
                    this.ws.onopen = () => { this.wsStatus = '‚óè connected'; this._wsRetry = 1000; };
                    this.ws.onclose = () => { this.wsStatus = '‚óã disconnected'; this._wsTimer = setTimeout(() => this.connectWS(), this._wsRetry); this._wsRetry = Math.min(this._wsRetry * 2, 30000); };
                    this.ws.onerror = () => { this.wsStatus = '‚ö† error'; };
                    this.ws.onmessage = (e) => {
                        let msg;
                        try { msg = JSON.parse(e.data); } catch { return; }
                        if (msg.type === 'init') {
                            this.tasks = (msg.tasks || []).map(t => ({ ...t, _showLog: t.status === 'running' || t.status === 'failed' }));
                        } else if (msg.type === 'update') {
                            const t = msg.task;
                            const idx = this.tasks.findIndex(x => x.id === t.id);
                            if (idx >= 0) {
                                const sl = this.tasks[idx]._showLog;
                                this.tasks.splice(idx, 1, { ...t, _showLog: sl });
                                if (sl) this.$nextTick(() => { const el = document.getElementById('log-' + t.id); if (el) el.scrollTop = el.scrollHeight; });
                            } else {
                                this.tasks.unshift({ ...t, _showLog: true }); // auto-expand logs for new tasks
                            }
                        }
                    };
                },

                async submit() {
                    if (!this.form.url.trim()) return;
                    this.loading = true;
                    try {
                        const payload = { ...this.form };
                        if (this.form.is_raw) { payload.args = this.form.url; payload.url = 'raw://placeholder'; }
                        const r = await fetch('/api/download', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!r.ok) {
                            const e = await r.json().catch(() => ({}));
                            this.showToast(e.error || 'Request failed', 'error');
                            return;
                        }
                        this.showToast(this.t('taskAdded'), 'success');
                    } catch (e) { this.showToast('Network error: ' + e.message, 'error'); } finally { this.loading = false; }
                },

                async showFormats() {
                    if (!this.form.url.trim()) return;
                    this.formatModal = true; this.formatOutput = this.t('loading');
                    try {
                        const r = await fetch('/api/formats', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: this.form.url }) });
                        const d = await r.json();
                        if (!r.ok || d.error) {
                            this.formatOutput = 'Error: ' + (d.error || 'Failed to list formats');
                        } else {
                            this.formatOutput = d.output || 'No output';
                        }
                    } catch (e) { this.formatOutput = 'Error: ' + e.message; }
                },

                async cancel(id) { try { const r = await fetch(`/api/tasks/${id}/cancel`, { method: 'POST' }); if (!r.ok) this.showToast('Cancel failed', 'error'); } catch(e) { this.showToast(e.message, 'error'); } },
                async pause(id) { try { const r = await fetch(`/api/tasks/${id}/pause`, { method: 'POST' }); if (!r.ok) this.showToast('Pause failed', 'error'); } catch(e) { this.showToast(e.message, 'error'); } },
                async resume(id) { try { const r = await fetch(`/api/tasks/${id}/resume`, { method: 'POST' }); if (!r.ok) this.showToast('Resume failed', 'error'); } catch(e) { this.showToast(e.message, 'error'); } },
                async retry(id) { try { const r = await fetch(`/api/tasks/${id}/retry`, { method: 'POST' }); if (!r.ok) this.showToast('Retry failed', 'error'); } catch(e) { this.showToast(e.message, 'error'); } },
                async del(id) { try { const r = await fetch(`/api/tasks/${id}`, { method: 'DELETE' }); if (r.ok) this.tasks = this.tasks.filter(t => t.id !== id); else this.showToast('Delete failed', 'error'); } catch(e) { this.showToast(e.message, 'error'); } },
                async clearDone() { try { const r = await fetch('/api/clear-completed', { method: 'POST' }); if (r.ok) this.tasks = this.tasks.filter(t => !['completed', 'failed', 'cancelled'].includes(t.status)); else this.showToast('Clear failed', 'error'); } catch(e) { this.showToast(e.message, 'error'); } },

                statusBadge(s) {
                    return { queued: 'badge-ghost', running: 'badge-primary animate-pulse', completed: 'badge-success', failed: 'badge-error', cancelled: 'badge-warning', paused: 'badge-info' }[s] || 'badge-ghost';
                },

                // Toast notification system
                toasts: [],
                toastId: 0,
                showToast(msg, type = 'info') {
                    const id = this.toastId++;
                    this.toasts.push({ id, msg, type });
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 4000);
                }
            };
        }
    </script>
</body>

</html>